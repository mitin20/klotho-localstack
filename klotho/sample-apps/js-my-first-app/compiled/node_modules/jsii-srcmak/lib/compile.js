"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.compile = void 0;
const crypto = __importStar(require("crypto"));
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const util_1 = require("./util");
const compilerModule = require.resolve('jsii/bin/jsii');
/**
 * Compiles the source files in `workdir` with jsii.
 */
async function compile(workdir, options) {
    var _a, _b, _c, _d;
    (0, util_1.validateOptions)(options);
    const args = ['--silence-warnings', 'reserved-word'];
    const entrypoint = (_a = options.entrypoint) !== null && _a !== void 0 ? _a : 'index.ts';
    if (path.extname(entrypoint) !== '.ts') {
        throw new Error(`jsii entrypoint must be a .ts file: ${entrypoint}`);
    }
    if (!(await fs.pathExists(path.join(workdir, entrypoint)))) {
        throw new Error(`unable to find typescript entrypoint: ${path.join(workdir, entrypoint)}`);
    }
    // path to entrypoint without extension
    const basepath = path.join(path.dirname(entrypoint), path.basename(entrypoint, '.ts'));
    const moduleKey = (_c = (_b = options.moduleKey) === null || _b === void 0 ? void 0 : _b.replace(/\./g, '').replace(/\//g, '')) !== null && _c !== void 0 ? _c : crypto.createHash('sha256').update(basepath, 'utf8').digest('hex');
    // jsii modules to include
    const moduleDirs = (_d = options.deps) !== null && _d !== void 0 ? _d : [];
    const targets = {};
    const deps = {};
    for (const dir of moduleDirs) {
        // read module metadata
        const metadata = await fs.readJson(path.join(dir, 'package.json'));
        const moduleName = metadata.name;
        const moduleVersion = metadata.version;
        const targetdir = path.join(path.join(workdir, 'node_modules'), moduleName);
        await fs.mkdirp(path.dirname(targetdir));
        await fs.copy(dir, targetdir);
        // add to "deps" and "peer deps"
        if (!moduleName.startsWith('@types/')) {
            deps[moduleName] = moduleVersion;
        }
    }
    const pkg = {
        name: moduleKey,
        version: '0.0.0',
        author: 'generated@generated.com',
        main: `${basepath}.js`,
        types: `${basepath}.d.ts`,
        license: 'UNLICENSED',
        repository: { url: 'http://generated', type: 'git' },
        jsii: {
            outdir: 'dist',
            targets: targets,
        },
        dependencies: deps,
        peerDependencies: deps,
    };
    if (options.python) {
        targets.python = {
            distName: 'generated',
            module: options.python.moduleName,
        };
    }
    if (options.java) {
        targets.java = {
            package: options.java.package,
            maven: {
                groupId: 'generated',
                artifactId: 'generated',
            },
        };
    }
    if (options.csharp) {
        targets.dotnet = {
            namespace: options.csharp.namespace,
            packageId: options.csharp.namespace,
        };
    }
    if (options.golang) {
        targets.go = {
            moduleName: options.golang.moduleName,
            packageName: options.golang.packageName,
        };
    }
    await fs.writeFile(path.join(workdir, 'package.json'), JSON.stringify(pkg, undefined, 2));
    await (0, util_1.exec)(compilerModule, args, {
        cwd: workdir,
    });
}
exports.compile = compile;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21waWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsK0NBQWlDO0FBQ2pDLDJDQUE2QjtBQUM3Qiw2Q0FBK0I7QUFFL0IsaUNBQStDO0FBRS9DLE1BQU0sY0FBYyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFFeEQ7O0dBRUc7QUFDSSxLQUFLLFVBQVUsT0FBTyxDQUFDLE9BQWUsRUFBRSxPQUFnQjs7SUFDN0QsSUFBQSxzQkFBZSxFQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRXpCLE1BQU0sSUFBSSxHQUFHLENBQUMsb0JBQW9CLEVBQUUsZUFBZSxDQUFDLENBQUM7SUFDckQsTUFBTSxVQUFVLEdBQUcsTUFBQSxPQUFPLENBQUMsVUFBVSxtQ0FBSSxVQUFVLENBQUM7SUFFcEQsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxLQUFLLEtBQUssRUFBRTtRQUN0QyxNQUFNLElBQUksS0FBSyxDQUFDLHVDQUF1QyxVQUFVLEVBQUUsQ0FBQyxDQUFDO0tBQ3RFO0lBRUQsSUFBSSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRTtRQUMxRCxNQUFNLElBQUksS0FBSyxDQUFDLHlDQUF5QyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDNUY7SUFFRCx1Q0FBdUM7SUFDdkMsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFFdkYsTUFBTSxTQUFT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LFVBQVU7WUFDckMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsV0FBVztTQUN4QyxDQUFDO0tBQ0g7SUFFRCxNQUFNLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsY0FBYyxDQUFDLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFMUYsTUFBTSxJQUFBLFdBQUksRUFBQyxjQUFjLEVBQUUsSUFBSSxFQUFFO1FBQy9CLEdBQUcsRUFBRSxPQUFPO0tBQ2IsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQTlGRCwwQkE4RkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjcnlwdG8gZnJvbSAnY3J5cHRvJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgeyBPcHRpb25zIH0gZnJvbSAnLi9vcHRpb25zJztcbmltcG9ydCB7IGV4ZWMsIHZhbGlkYXRlT3B0aW9ucyB9IGZyb20gJy4vdXRpbCc7XG5cbmNvbnN0IGNvbXBpbGVyTW9kdWxlID0gcmVxdWlyZS5yZXNvbHZlKCdqc2lpL2Jpbi9qc2lpJyk7XG5cbi8qKlxuICogQ29tcGlsZXMgdGhlIHNvdXJjZSBmaWxlcyBpbiBgd29ya2RpcmAgd2l0aCBqc2lpLlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY29tcGlsZSh3b3JrZGlyOiBzdHJpbmcsIG9wdGlvbnM6IE9wdGlvbnMpIHtcbiAgdmFsaWRhdGVPcHRpb25zKG9wdGlvbnMpO1xuXG4gIGNvbnN0IGFyZ3MgPSBbJy0tc2lsZW5jZS13YXJuaW5ncycsICdyZXNlcnZlZC13b3JkJ107XG4gIGNvbnN0IGVudHJ5cG9pbnQgPSBvcHRpb25zLmVudHJ5cG9pbnQgPz8gJ2luZGV4LnRzJztcblxuICBpZiAocGF0aC5leHRuYW1lKGVudHJ5cG9pbnQpICE9PSAnLnRzJykge1xuICAgIHRocm93IG5ldyBFcnJvcihganNpaSBlbnRyeXBvaW50IG11c3QgYmUgYSAudHMgZmlsZTogJHtlbnRyeXBvaW50fWApO1xuICB9XG5cbiAgaWYgKCEoYXdhaXQgZnMucGF0aEV4aXN0cyhwYXRoLmpvaW4od29ya2RpciwgZW50cnlwb2ludCkpKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgdW5hYmxlIHRvIGZpbmQgdHlwZXNjcmlwdCBlbnRyeXBvaW50OiAke3BhdGguam9pbih3b3JrZGlyLCBlbnRyeXBvaW50KX1gKTtcbiAgfVxuXG4gIC8vIHBhdGggdG8gZW50cnlwb2ludCB3aXRob3V0IGV4dGVuc2lvblxuICBjb25zdCBiYXNlcGF0aCA9IHBhdGguam9pbihwYXRoLmRpcm5hbWUoZW50cnlwb2ludCksIHBhdGguYmFzZW5hbWUoZW50cnlwb2ludCwgJy50cycpKTtcblxuICBjb25zdCBtb2R1bGVLZXkgPSBvcHRpb25zLm1vZHVsZUtleT8ucmVwbGFjZSgvXFwuL2csICcnKS5yZXBsYWNlKC9cXC8vZywgJycpID8/IGNyeXB0by5jcmVhdGVIYXNoKCdzaGEyNTYnKS51cGRhdGUoYmFzZXBhdGgsICd1dGY4JykuZGlnZXN0KCdoZXgnKTtcblxuICAvLyBqc2lpIG1vZHVsZXMgdG8gaW5jbHVkZVxuICBjb25zdCBtb2R1bGVEaXJzID0gb3B0aW9ucy5kZXBzID8/IFtdO1xuXG4gIGNvbnN0IHRhcmdldHM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7IH07XG5cbiAgY29uc3QgZGVwczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHsgfTtcblxuICBmb3IgKGNvbnN0IGRpciBvZiBtb2R1bGVEaXJzKSB7XG4gICAgLy8gcmVhZCBtb2R1bGUgbWV0YWRhdGFcbiAgICBjb25zdCBtZXRhZGF0YSA9IGF3YWl0IGZzLnJlYWRKc29uKHBhdGguam9pbihkaXIsICdwYWNrYWdlLmpzb24nKSk7XG4gICAgY29uc3QgbW9kdWxlTmFtZTogc3RyaW5nID0gbWV0YWRhdGEubmFtZTtcbiAgICBjb25zdCBtb2R1bGVWZXJzaW9uOiBzdHJpbmcgPSBtZXRhZGF0YS52ZXJzaW9uO1xuXG4gICAgY29uc3QgdGFyZ2V0ZGlyID0gcGF0aC5qb2luKHBhdGguam9pbih3b3JrZGlyLCAnbm9kZV9tb2R1bGVzJyksIG1vZHVsZU5hbWUpO1xuICAgIGF3YWl0IGZzLm1rZGlycChwYXRoLmRpcm5hbWUodGFyZ2V0ZGlyKSk7XG4gICAgYXdhaXQgZnMuY29weShkaXIsIHRhcmdldGRpcik7XG5cbiAgICAvLyBhZGQgdG8gXCJkZXBzXCIgYW5kIFwicGVlciBkZXBzXCJcbiAgICBpZiAoIW1vZHVsZU5hbWUuc3RhcnRzV2l0aCgnQHR5cGVzLycpKSB7XG4gICAgICBkZXBzW21vZHVsZU5hbWVdID0gbW9kdWxlVmVyc2lvbjtcbiAgICB9XG4gIH1cblxuICBjb25zdCBwa2cgPSB7XG4gICAgbmFtZTogbW9kdWxlS2V5LFxuICAgIHZlcnNpb246ICcwLjAuMCcsXG4gICAgYXV0aG9yOiAnZ2VuZXJhdGVkQGdlbmVyYXRlZC5jb20nLFxuICAgIG1haW46IGAke2Jhc2VwYXRofS5qc2AsXG4gICAgdHlwZXM6IGAke2Jhc2VwYXRofS5kLnRzYCxcbiAgICBsaWNlbnNlOiAnVU5MSUNFTlNFRCcsXG4gICAgcmVwb3NpdG9yeTogeyB1cmw6ICdodHRwOi8vZ2VuZXJhdGVkJywgdHlwZTogJ2dpdCcgfSxcbiAgICBqc2lpOiB7XG4gICAgICBvdXRkaXI6ICdkaXN0JyxcbiAgICAgIHRhcmdldHM6IHRhcmdldHMsXG4gICAgfSxcbiAgICBkZXBlbmRlbmNpZXM6IGRlcHMsXG4gICAgcGVlckRlcGVuZGVuY2llczogZGVwcyxcbiAgfTtcblxuICBpZiAob3B0aW9ucy5weXRob24pIHtcbiAgICB0YXJnZXRzLnB5dGhvbiA9IHtcbiAgICAgIGRpc3ROYW1lOiAnZ2VuZXJhdGVkJyxcbiAgICAgIG1vZHVsZTogb3B0aW9ucy5weXRob24ubW9kdWxlTmFtZSxcbiAgICB9O1xuICB9XG5cbiAgaWYgKG9wdGlvbnMuamF2YSkge1xuICAgIHRhcmdldHMuamF2YSA9IHtcbiAgICAgIHBhY2thZ2U6IG9wdGlvbnMuamF2YS5wYWNrYWdlLFxuICAgICAgbWF2ZW46IHtcbiAgICAgICAgZ3JvdXBJZDogJ2dlbmVyYXRlZCcsXG4gICAgICAgIGFydGlmYWN0SWQ6ICdnZW5lcmF0ZWQnLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgaWYgKG9wdGlvbnMuY3NoYXJwKSB7XG4gICAgdGFyZ2V0cy5kb3RuZXQgPSB7XG4gICAgICBuYW1lc3BhY2U6IG9wdGlvbnMuY3NoYXJwLm5hbWVzcGFjZSxcbiAgICAgIHBhY2thZ2VJZDogb3B0aW9ucy5jc2hhcnAubmFtZXNwYWNlLFxuICAgIH07XG4gIH1cblxuICBpZiAob3B0aW9ucy5nb2xhbmcpIHtcbiAgICB0YXJnZXRzLmdvID0ge1xuICAgICAgbW9kdWxlTmFtZTogb3B0aW9ucy5nb2xhbmcubW9kdWxlTmFtZSxcbiAgICAgIHBhY2thZ2VOYW1lOiBvcHRpb25zLmdvbGFuZy5wYWNrYWdlTmFtZSxcbiAgICB9O1xuICB9XG5cbiAgYXdhaXQgZnMud3JpdGVGaWxlKHBhdGguam9pbih3b3JrZGlyLCAncGFja2FnZS5qc29uJyksIEpTT04uc3RyaW5naWZ5KHBrZywgdW5kZWZpbmVkLCAyKSk7XG5cbiAgYXdhaXQgZXhlYyhjb21waWxlck1vZHVsZSwgYXJncywge1xuICAgIGN3ZDogd29ya2RpcixcbiAgfSk7XG59XG4iXX0=