"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.Helm = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const fs = require("fs");
const os = require("os");
const path = require("path");
const _child_process_1 = require("./_child_process");
const include_1 = require("./include");
const names_1 = require("./names");
const yaml_1 = require("./yaml");
const MAX_HELM_BUFFER = 10 * 1024 * 1024;
/**
 * Represents a Helm deployment.
 *
 * Use this construct to import an existing Helm chart and incorporate it into your constructs.
 */
class Helm extends include_1.Include {
    constructor(scope, id, props) {
        const workdir = fs.mkdtempSync(path.join(os.tmpdir(), 'cdk8s-helm-'));
        const args = new Array();
        args.push('template');
        // values
        if (props.values && Object.keys(props.values).length > 0) {
            const valuesPath = path.join(workdir, 'overrides.yaml');
            fs.writeFileSync(valuesPath, yaml_1.Yaml.stringify(props.values));
            args.push('-f', valuesPath);
        }
        if (props.repo) {
            args.push('--repo', props.repo);
        }
        if (props.version) {
            args.push('--version', props.version);
        }
        if (props.namespace) {
            args.push('--namespace', props.namespace);
        }
        // custom flags
        if (props.helmFlags) {
            args.push(...props.helmFlags);
        }
        // release name
        // constraints: https://github.com/helm/helm/issues/6006
        const releaseName = props.releaseName ?? names_1.Names.toDnsLabel(scope, { maxLen: 53, extra: [id] });
        args.push(releaseName);
        // chart
        args.push(props.chart);
        const prog = props.helmExecutable ?? 'helm';
        const outputFile = renderTemplate(workdir, prog, args);
        super(scope, id, { url: outputFile });
        this.releaseName = releaseName;
    }
}
exports.Helm = Helm;
_a = JSII_RTTI_SYMBOL_1;
Helm[_a] = { fqn: "cdk8s.Helm", version: "2.7.77" };
function renderTemplate(workdir, prog, args) {
    const helm = _child_process_1._child_process.spawnSync(prog, args, {
        maxBuffer: MAX_HELM_BUFFER,
    });
    if (helm.error) {
        const err = helm.error.message;
        if (err.includes('ENOENT')) {
            throw new Error(`unable to execute '${prog}' to render Helm chart. Is it installed on your system?`);
        }
        throw new Error(`error while rendering a helm chart: ${err}`);
    }
    if (helm.status !== 0) {
        throw new Error(helm.stderr.toString());
    }
    const outputFile = path.join(workdir, 'chart.yaml');
    const stdout = helm.stdout;
    fs.writeFileSync(outputFile, stdout);
    return outputFile;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVsbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9oZWxtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEseUJBQXlCO0FBQ3pCLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFFN0IscURBQWtEO0FBQ2xELHVDQUFvQztBQUNwQyxtQ0FBZ0M7QUFDaEMsaUNBQThCO0FBRTlCLE1BQU0sZUFBZSxHQUFHLEVBQUUsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBcUV6Qzs7OztHQUlHO0FBQ0gsTUFBYSxJQUFLLFNBQVEsaUJBQU87SUFNL0IsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFnQjtRQUN4RCxNQUFNLE9BQU8sR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQUM7UUFFdEUsTUFBTSxJQUFJLEdBQUcsSUFBSSxLQUFLLEVBQVUsQ0FBQztRQUNqQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRXRCLFNBQVM7UUFDVCxJQUFJLEtBQUssQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN4RCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ3hELEVBQUUsQ0FBQyxhQUFhLENBQUMsVUFBVSxFQUFFLFdBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDM0QsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7U0FDN0I7UUFFRCxJQUFJLEtBQUssQ0FBQyxJQUFJLEVBQUU7WUFDZCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDakM7UUFFRCxJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUU7WUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ3ZDO1FBRUQsSUFBSSxLQUFLLENBQUMsU0FBUyxFQUFFO1lBQ25CLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUMzQztRQUVELGVBQWU7UUFDZixJQUFJLEtBQUssQ0FBQyxTQUFTLEVBQUU7WUFDbkIsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUMvQjtRQUVELGVBQWU7UUFDZix3REFBd0Q7UUFDeEQsTUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFDLFdBQVcsSUFBSSxhQUFLLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzlGLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFdkIsUUFBUTtRQUNSLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXZCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxjQUFjLElBQUksTUFBTSxDQUFDO1FBQzVDLE1BQU0sVUFBVSxHQUFHLGNBQWMsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRXZELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUM7UUFFdEMsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7SUFDakMsQ0FBQzs7QUFsREgsb0JBbURDOzs7QUFFRCxTQUFTLGNBQWMsQ0FBQyxPQUFlLEVBQUUsSUFBWSxFQUFFLElBQWM7SUFDbkUsTUFBTSxJQUFJLEdBQUcsK0JBQWMsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRTtRQUNoRCxTQUFTLEVBQUUsZUFBZTtLQUMzQixDQUFDLENBQUM7SUFFSCxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7UUFDZCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQztRQUMvQixJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDMUIsTUFBTSxJQUFJLEtBQUssQ0FBQyxzQkFBc0IsSUFBSSx5REFBeUQsQ0FBQyxDQUFDO1NBQ3RHO1FBRUQsTUFBTSxJQUFJLEtBQUssQ0FBQyx1Q0FBdUMsR0FBRyxFQUFFLENBQUMsQ0FBQztLQUMvRDtJQUVELElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7UUFDckIsTUFBTSxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7S0FDekM7SUFFRCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxZQUFZLENBQUMsQ0FBQztJQUNwRCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQzNCLEVBQUUsQ0FBQyxhQUFhLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ3JDLE9BQU8sVUFBVSxDQUFDO0FBQ3BCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBvcyBmcm9tICdvcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBfY2hpbGRfcHJvY2VzcyB9IGZyb20gJy4vX2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IHsgSW5jbHVkZSB9IGZyb20gJy4vaW5jbHVkZSc7XG5pbXBvcnQgeyBOYW1lcyB9IGZyb20gJy4vbmFtZXMnO1xuaW1wb3J0IHsgWWFtbCB9IGZyb20gJy4veWFtbCc7XG5cbmNvbnN0IE1BWF9IRUxNX0JVRkZFUiA9IDEwICogMTAyNCAqIDEwMjQ7XG5cbi8qKlxuICogT3B0aW9ucyBmb3IgYEhlbG1gLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIEhlbG1Qcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgY2hhcnQgbmFtZSB0byB1c2UuIEl0IGNhbiBiZSBhIGNoYXJ0IGZyb20gYSBoZWxtIHJlcG9zaXRvcnkgb3IgYSBsb2NhbCBkaXJlY3RvcnkuXG4gICAqXG4gICAqIFRoaXMgbmFtZSBpcyBwYXNzZWQgdG8gYGhlbG0gdGVtcGxhdGVgIGFuZCBoYXMgYWxsIHRoZSByZWxldmFudCBzZW1hbnRpY3MuXG4gICAqXG4gICAqIEBleGFtcGxlIFwiLi9teXNxbFwiXG4gICAqIEBleGFtcGxlIFwiYml0bmFtaS9yZWRpc1wiXG4gICAqL1xuICByZWFkb25seSBjaGFydDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBDaGFydCByZXBvc2l0b3J5IHVybCB3aGVyZSB0byBsb2NhdGUgdGhlIHJlcXVlc3RlZCBjaGFydFxuICAgKi9cbiAgcmVhZG9ubHkgcmVwbz86IHN0cmluZztcblxuICAvKipcbiAgICogVmVyc2lvbiBjb25zdHJhaW50IGZvciB0aGUgY2hhcnQgdmVyc2lvbiB0byB1c2UuXG4gICAqIFRoaXMgY29uc3RyYWludCBjYW4gYmUgYSBzcGVjaWZpYyB0YWcgKGUuZy4gMS4xLjEpXG4gICAqIG9yIGl0IG1heSByZWZlcmVuY2UgYSB2YWxpZCByYW5nZSAoZS5nLiBeMi4wLjApLlxuICAgKiBJZiB0aGlzIGlzIG5vdCBzcGVjaWZpZWQsIHRoZSBsYXRlc3QgdmVyc2lvbiBpcyB1c2VkXG4gICAqXG4gICAqIFRoaXMgbmFtZSBpcyBwYXNzZWQgdG8gYGhlbG0gdGVtcGxhdGUgLS12ZXJzaW9uYCBhbmQgaGFzIGFsbCB0aGUgcmVsZXZhbnQgc2VtYW50aWNzLlxuICAgKlxuICAgKiBAZXhhbXBsZSBcIjEuMS4xXCJcbiAgICogQGV4YW1wbGUgXCJeMi4wLjBcIlxuICAgKi9cbiAgcmVhZG9ubHkgdmVyc2lvbj86IHN0cmluZztcblxuICAvKipcbiAgICogU2NvcGUgYWxsIHJlc291cmNlcyBpbiB0byBhIGdpdmVuIG5hbWVzcGFjZS5cbiAgICovXG4gIHJlYWRvbmx5IG5hbWVzcGFjZT86IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIHJlbGVhc2UgbmFtZS5cbiAgICpcbiAgICogQHNlZSBodHRwczovL2hlbG0uc2gvZG9jcy9pbnRyby91c2luZ19oZWxtLyN0aHJlZS1iaWctY29uY2VwdHNcbiAgICogQGRlZmF1bHQgLSBpZiB1bnNwZWNpZmllZCwgYSBuYW1lIHdpbGwgYmUgYWxsb2NhdGVkIGJhc2VkIG9uIHRoZSBjb25zdHJ1Y3QgcGF0aFxuICAgKi9cbiAgcmVhZG9ubHkgcmVsZWFzZU5hbWU/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFZhbHVlcyB0byBwYXNzIHRvIHRoZSBjaGFydC5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBJZiBubyB2YWx1ZXMgYXJlIHNwZWNpZmllZCwgY2hhcnQgd2lsbCB1c2UgdGhlIGRlZmF1bHRzLlxuICAgKi9cbiAgcmVhZG9ubHkgdmFsdWVzPzogeyBba2V5OiBzdHJpbmddOiBhbnkgfTtcblxuICAvKipcbiAgICogVGhlIGxvY2FsIGhlbG0gZXhlY3V0YWJsZSB0byB1c2UgaW4gb3JkZXIgdG8gY3JlYXRlIHRoZSBtYW5pZmVzdCB0aGUgY2hhcnQuXG4gICAqXG4gICAqIEBkZWZhdWx0IFwiaGVsbVwiXG4gICAqL1xuICByZWFkb25seSBoZWxtRXhlY3V0YWJsZT86IHN0cmluZztcblxuICAvKipcbiAgICogQWRkaXRpb25hbCBmbGFncyB0byBhZGQgdG8gdGhlIGBoZWxtYCBleGVjdXRpb24uXG4gICAqXG4gICAqIEBkZWZhdWx0IFtdXG4gICAqL1xuICByZWFkb25seSBoZWxtRmxhZ3M/OiBzdHJpbmdbXTtcbn1cblxuLyoqXG4gKiBSZXByZXNlbnRzIGEgSGVsbSBkZXBsb3ltZW50LlxuICpcbiAqIFVzZSB0aGlzIGNvbnN0cnVjdCB0byBpbXBvcnQgYW4gZXhpc3RpbmcgSGVsbSBjaGFydCBhbmQgaW5jb3Jwb3JhdGUgaXQgaW50byB5b3VyIGNvbnN0cnVjdHMuXG4gKi9cbmV4cG9ydCBjbGFzcyBIZWxtIGV4dGVuZHMgSW5jbHVkZSB7XG4gIC8qKlxuICAgKiBUaGUgaGVsbSByZWxlYXNlIG5hbWUuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgcmVsZWFzZU5hbWU6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogSGVsbVByb3BzKSB7XG4gICAgY29uc3Qgd29ya2RpciA9IGZzLm1rZHRlbXBTeW5jKHBhdGguam9pbihvcy50bXBkaXIoKSwgJ2NkazhzLWhlbG0tJykpO1xuXG4gICAgY29uc3QgYXJncyA9IG5ldyBBcnJheTxzdHJpbmc+KCk7XG4gICAgYXJncy5wdXNoKCd0ZW1wbGF0ZScpO1xuXG4gICAgLy8gdmFsdWVzXG4gICAgaWYgKHByb3BzLnZhbHVlcyAmJiBPYmplY3Qua2V5cyhwcm9wcy52YWx1ZXMpLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHZhbHVlc1BhdGggPSBwYXRoLmpvaW4od29ya2RpciwgJ292ZXJyaWRlcy55YW1sJyk7XG4gICAgICBmcy53cml0ZUZpbGVTeW5jKHZhbHVlc1BhdGgsIFlhbWwuc3RyaW5naWZ5KHByb3BzLnZhbHVlcykpO1xuICAgICAgYXJncy5wdXNoKCctZicsIHZhbHVlc1BhdGgpO1xuICAgIH1cblxuICAgIGlmIChwcm9wcy5yZXBvKSB7XG4gICAgICBhcmdzLnB1c2goJy0tcmVwbycsIHByb3BzLnJlcG8pO1xuICAgIH1cblxuICAgIGlmIChwcm9wcy52ZXJzaW9uKSB7XG4gICAgICBhcmdzLnB1c2goJy0tdmVyc2lvbicsIHByb3BzLnZlcnNpb24pO1xuICAgIH1cblxuICAgIGlmIChwcm9wcy5uYW1lc3BhY2UpIHtcbiAgICAgIGFyZ3MucHVzaCgnLS1uYW1lc3BhY2UnLCBwcm9wcy5uYW1lc3BhY2UpO1xuICAgIH1cblxuICAgIC8vIGN1c3RvbSBmbGFnc1xuICAgIGlmIChwcm9wcy5oZWxtRmxhZ3MpIHtcbiAgICAgIGFyZ3MucHVzaCguLi5wcm9wcy5oZWxtRmxhZ3MpO1xuICAgIH1cblxuICAgIC8vIHJlbGVhc2UgbmFtZVxuICAgIC8vIGNvbnN0cmFpbnRzOiBodHRwczovL2dpdGh1Yi5jb20vaGVsbS9oZWxtL2lzc3Vlcy82MDA2XG4gICAgY29uc3QgcmVsZWFzZU5hbWUgPSBwcm9wcy5yZWxlYXNlTmFtZSA/PyBOYW1lcy50b0Ruc0xhYmVsKHNjb3BlLCB7IG1heExlbjogNTMsIGV4dHJhOiBbaWRdIH0pO1xuICAgIGFyZ3MucHVzaChyZWxlYXNlTmFtZSk7XG5cbiAgICAvLyBjaGFydFxuICAgIGFyZ3MucHVzaChwcm9wcy5jaGFydCk7XG5cbiAgICBjb25zdCBwcm9nID0gcHJvcHMuaGVsbUV4ZWN1dGFibGUgPz8gJ2hlbG0nO1xuICAgIGNvbnN0IG91dHB1dEZpbGUgPSByZW5kZXJUZW1wbGF0ZSh3b3JrZGlyLCBwcm9nLCBhcmdzKTtcblxuICAgIHN1cGVyKHNjb3BlLCBpZCwgeyB1cmw6IG91dHB1dEZpbGUgfSk7XG5cbiAgICB0aGlzLnJlbGVhc2VOYW1lID0gcmVsZWFzZU5hbWU7XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVuZGVyVGVtcGxhdGUod29ya2Rpcjogc3RyaW5nLCBwcm9nOiBzdHJpbmcsIGFyZ3M6IHN0cmluZ1tdKSB7XG4gIGNvbnN0IGhlbG0gPSBfY2hpbGRfcHJvY2Vzcy5zcGF3blN5bmMocHJvZywgYXJncywge1xuICAgIG1heEJ1ZmZlcjogTUFYX0hFTE1fQlVGRkVSLFxuICB9KTtcblxuICBpZiAoaGVsbS5lcnJvcikge1xuICAgIGNvbnN0IGVyciA9IGhlbG0uZXJyb3IubWVzc2FnZTtcbiAgICBpZiAoZXJyLmluY2x1ZGVzKCdFTk9FTlQnKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmFibGUgdG8gZXhlY3V0ZSAnJHtwcm9nfScgdG8gcmVuZGVyIEhlbG0gY2hhcnQuIElzIGl0IGluc3RhbGxlZCBvbiB5b3VyIHN5c3RlbT9gKTtcbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoYGVycm9yIHdoaWxlIHJlbmRlcmluZyBhIGhlbG0gY2hhcnQ6ICR7ZXJyfWApO1xuICB9XG5cbiAgaWYgKGhlbG0uc3RhdHVzICE9PSAwKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGhlbG0uc3RkZXJyLnRvU3RyaW5nKCkpO1xuICB9XG5cbiAgY29uc3Qgb3V0cHV0RmlsZSA9IHBhdGguam9pbih3b3JrZGlyLCAnY2hhcnQueWFtbCcpO1xuICBjb25zdCBzdGRvdXQgPSBoZWxtLnN0ZG91dDtcbiAgZnMud3JpdGVGaWxlU3luYyhvdXRwdXRGaWxlLCBzdGRvdXQpO1xuICByZXR1cm4gb3V0cHV0RmlsZTtcbn1cbiJdfQ==