"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs = __importStar(require("fs"));
const yaml = __importStar(require("yaml"));
const config_1 = require("../../config");
const _manager_1 = require("../../plugins/_manager");
const util_1 = require("../../util");
const config = (0, config_1.readConfigSync)();
class Command {
    constructor() {
        this.command = 'synth';
        this.describe = 'Synthesizes Kubernetes manifests for all charts in your app.';
        this.aliases = ['synthesize'];
        this.builder = (args) => args
            .option('app', { default: config.app, required: true, desc: 'Command to use in order to execute cdk8s app', alias: 'a' })
            .option('output', { default: config.output, required: false, desc: 'Output directory', alias: 'o' })
            .option('stdout', { type: 'boolean', required: false, desc: 'Write synthesized manifests to STDOUT instead of the output directory', alias: 'p' })
            .option('plugins-dir', { default: config.pluginsDirectory, required: false, desc: 'Directory to store cdk8s plugins.' })
            .option('validate', { type: 'boolean', default: true, required: false, desc: 'Apply validation plugins on the resulting manifests (use --no-validate to disable)' })
            .option('validation-reports-output-file', { required: false, desc: 'File to write a JSON representation of the validation reports to' });
    }
    ;
    async handler(argv) {
        const command = argv.app;
        const outdir = argv.output;
        const stdout = argv.stdout;
        const validate = argv.validate;
        const pluginsDir = argv.pluginsDir;
        const reportFile = argv.validationReportsOutputFile;
        if (outdir && outdir !== config.output && stdout) {
            throw new Error('\'--output\' and \'--stdout\' are mutually exclusive. Please only use one.');
        }
        if (outdir) {
            fs.rmSync(outdir, { recursive: true, force: true });
        }
        const validations = validate ? await fetchValidations() : undefined;
        const recordConstructMetadata = !(validations == undefined || validations.length == 0);
        if (stdout) {
            await (0, util_1.mkdtemp)(async (tempDir) => {
                const app = await (0, util_1.synthApp)(command, tempDir, stdout, recordConstructMetadata);
                for (const f of app.manifests) {
                    fs.createReadStream(f).pipe(process.stdout);
                }
                if (validations) {
                    const pluginManager = new _manager_1.PluginManager(pluginsDir);
                    await (0, util_1.validateApp)(app, stdout, validations, pluginManager, reportFile);
                }
            });
        }
        else {
            const manifests = await (0, util_1.synthApp)(command, outdir, stdout, recordConstructMetadata);
            if (validations) {
                const pluginManager = new _manager_1.PluginManager(pluginsDir);
                await (0, util_1.validateApp)(manifests, stdout, validations, pluginManager, reportFile);
            }
        }
    }
}
async function fetchValidations() {
    if (typeof (config.validations) === 'string') {
        const content = await (0, util_1.download)(config.validations);
        return yaml.parse(content);
    }
    else {
        return config.validations;
    }
}
module.exports = new Command();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ludGguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY2xpL2NtZHMvc3ludGgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLHVDQUF5QjtBQUN6QiwyQ0FBNkI7QUFFN0IseUNBQWdFO0FBQ2hFLHFEQUF1RDtBQUN2RCxxQ0FBc0U7QUFFdEUsTUFBTSxNQUFNLEdBQUcsSUFBQSx1QkFBYyxHQUFFLENBQUM7QUFFaEMsTUFBTSxPQUFPO0lBQWI7UUFDa0IsWUFBTyxHQUFHLE9BQU8sQ0FBQztRQUNsQixhQUFRLEdBQUcsOERBQThELENBQUM7UUFDMUUsWUFBTyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFekIsWUFBTyxHQUFHLENBQUMsSUFBZ0IsRUFBRSxFQUFFLENBQUMsSUFBSTthQUNqRCxNQUFNLENBQUMsS0FBSyxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxHQUFHLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsOENBQThDLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxDQUFDO2FBQ3hILE1BQU0sQ0FBQyxRQUFRLEVBQUUsRUFBRSxPQUFPLEVBQUUsTUFBTSxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxrQkFBa0IsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUM7YUFDbkcsTUFBTSxDQUFDLFFBQVEsRUFBRSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsdUVBQXVFLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxDQUFDO2FBQ2pKLE1BQU0sQ0FBQyxhQUFhLEVBQUUsRUFBRSxPQUFPLEVBQUUsTUFBTSxDQUFDLGdCQUFnQixFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLG1DQUFtQyxFQUFFLENBQUM7YUFDdkgsTUFBTSxD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QUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUF1QixDQUFDO0tBQ2xEO1NBQU07UUFDTCxPQUFPLE1BQU0sQ0FBQyxXQUFXLENBQUM7S0FDM0I7QUFDSCxDQUFDO0FBR0QsTUFBTSxDQUFDLE9BQU8sR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgeWFtbCBmcm9tICd5YW1sJztcbmltcG9ydCAqIGFzIHlhcmdzIGZyb20gJ3lhcmdzJztcbmltcG9ydCB7IHJlYWRDb25maWdTeW5jLCBWYWxpZGF0aW9uQ29uZmlnIH0gZnJvbSAnLi4vLi4vY29uZmlnJztcbmltcG9ydCB7IFBsdWdpbk1hbmFnZXIgfSBmcm9tICcuLi8uLi9wbHVnaW5zL19tYW5hZ2VyJztcbmltcG9ydCB7IHN5bnRoQXBwLCBta2R0ZW1wLCBkb3dubG9hZCwgdmFsaWRhdGVBcHAgfSBmcm9tICcuLi8uLi91dGlsJztcblxuY29uc3QgY29uZmlnID0gcmVhZENvbmZpZ1N5bmMoKTtcblxuY2xhc3MgQ29tbWFuZCBpbXBsZW1lbnRzIHlhcmdzLkNvbW1hbmRNb2R1bGUge1xuICBwdWJsaWMgcmVhZG9ubHkgY29tbWFuZCA9ICdzeW50aCc7XG4gIHB1YmxpYyByZWFkb25seSBkZXNjcmliZSA9ICdTeW50aGVzaXplcyBLdWJlcm5ldGVzIG1hbmlmZXN0cyBmb3IgYWxsIGNoYXJ0cyBpbiB5b3VyIGFwcC4nO1xuICBwdWJsaWMgcmVhZG9ubHkgYWxpYXNlcyA9IFsnc3ludGhlc2l6ZSddO1xuXG4gIHB1YmxpYyByZWFkb25seSBidWlsZGVyID0gKGFyZ3M6IHlhcmdzLkFyZ3YpID0+IGFyZ3NcbiAgICAub3B0aW9uKCdhcHAnLCB7IGRlZmF1bHQ6IGNvbmZpZy5hcHAsIHJlcXVpcmVkOiB0cnVlLCBkZXNjOiAnQ29tbWFuZCB0byB1c2UgaW4gb3JkZXIgdG8gZXhlY3V0ZSBjZGs4cyBhcHAnLCBhbGlhczogJ2EnIH0pXG4gICAgLm9wdGlvbignb3V0cHV0JywgeyBkZWZhdWx0OiBjb25maWcub3V0cHV0LCByZXF1aXJlZDogZmFsc2UsIGRlc2M6ICdPdXRwdXQgZGlyZWN0b3J5JywgYWxpYXM6ICdvJyB9KVxuICAgIC5vcHRpb24oJ3N0ZG91dCcsIHsgdHlwZTogJ2Jvb2xlYW4nLCByZXF1aXJlZDogZmFsc2UsIGRlc2M6ICdXcml0ZSBzeW50aGVzaXplZCBtYW5pZmVzdHMgdG8gU1RET1VUIGluc3RlYWQgb2YgdGhlIG91dHB1dCBkaXJlY3RvcnknLCBhbGlhczogJ3AnIH0pXG4gICAgLm9wdGlvbigncGx1Z2lucy1kaXInLCB7IGRlZmF1bHQ6IGNvbmZpZy5wbHVnaW5zRGlyZWN0b3J5LCByZXF1aXJlZDogZmFsc2UsIGRlc2M6ICdEaXJlY3RvcnkgdG8gc3RvcmUgY2RrOHMgcGx1Z2lucy4nIH0pXG4gICAgLm9wdGlvbigndmFsaWRhdGUnLCB7IHR5cGU6ICdib29sZWFuJywgZGVmYXVsdDogdHJ1ZSwgcmVxdWlyZWQ6IGZhbHNlLCBkZXNjOiAnQXBwbHkgdmFsaWRhdGlvbiBwbHVnaW5zIG9uIHRoZSByZXN1bHRpbmcgbWFuaWZlc3RzICh1c2UgLS1uby12YWxpZGF0ZSB0byBkaXNhYmxlKScgfSlcbiAgICAub3B0aW9uKCd2YWxpZGF0aW9uLXJlcG9ydHMtb3V0cHV0LWZpbGUnLCB7IHJlcXVpcmVkOiBmYWxzZSwgZGVzYzogJ0ZpbGUgdG8gd3JpdGUgYSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIHRoZSB2YWxpZGF0aW9uIHJlcG9ydHMgdG8nIH0pO1xuICA7XG5cbiAgcHVibGljIGFzeW5jIGhhbmRsZXIoYXJndjogYW55KSB7XG5cbiAgICBjb25zdCBjb21tYW5kID0gYXJndi5hcHA7XG4gICAgY29uc3Qgb3V0ZGlyID0gYXJndi5vdXRwdXQ7XG4gICAgY29uc3Qgc3Rkb3V0ID0gYXJndi5zdGRvdXQ7XG4gICAgY29uc3QgdmFsaWRhdGUgPSBhcmd2LnZhbGlkYXRlO1xuICAgIGNvbnN0IHBsdWdpbnNEaXIgPSBhcmd2LnBsdWdpbnNEaXI7XG4gICAgY29uc3QgcmVwb3J0RmlsZSA9IGFyZ3YudmFsaWRhdGlvblJlcG9ydHNPdXRwdXRGaWxlO1xuXG4gICAgaWYgKG91dGRpciAmJiBvdXRkaXIgIT09IGNvbmZpZy5vdXRwdXQgJiYgc3Rkb3V0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1xcJy0tb3V0cHV0XFwnIGFuZCBcXCctLXN0ZG91dFxcJyBhcmUgbXV0dWFsbHkgZXhjbHVzaXZlLiBQbGVhc2Ugb25seSB1c2Ugb25lLicpO1xuICAgIH1cblxuICAgIGlmIChvdXRkaXIpIHtcbiAgICAgIGZzLnJtU3luYyhvdXRkaXIsIHsgcmVjdXJzaXZlOiB0cnVlLCBmb3JjZTogdHJ1ZSB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB2YWxpZGF0aW9ucyA9IHZhbGlkYXRlID8gYXdhaXQgZmV0Y2hWYWxpZGF0aW9ucygpIDogdW5kZWZpbmVkO1xuICAgIGNvbnN0IHJlY29yZENvbnN0cnVjdE1ldGFkYXRhID0gISh2YWxpZGF0aW9ucyA9PSB1bmRlZmluZWQgfHwgdmFsaWRhdGlvbnMubGVuZ3RoID09IDApO1xuXG4gICAgaWYgKHN0ZG91dCkge1xuICAgICAgYXdhaXQgbWtkdGVtcChhc3luYyB0ZW1wRGlyID0+IHtcbiAgICAgICAgY29uc3QgYXBwID0gYXdhaXQgc3ludGhBcHAoY29tbWFuZCwgdGVtcERpciwgc3Rkb3V0LCByZWNvcmRDb25zdHJ1Y3RNZXRhZGF0YSk7XG4gICAgICAgIGZvciAoY29uc3QgZiBvZiBhcHAubWFuaWZlc3RzKSB7XG4gICAgICAgICAgZnMuY3JlYXRlUmVhZFN0cmVhbShmKS5waXBlKHByb2Nlc3Muc3Rkb3V0KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodmFsaWRhdGlvbnMpIHtcbiAgICAgICAgICBjb25zdCBwbHVnaW5NYW5hZ2VyID0gbmV3IFBsdWdpbk1hbmFnZXIocGx1Z2luc0Rpcik7XG4gICAgICAgICAgYXdhaXQgdmFsaWRhdGVBcHAoYXBwLCBzdGRvdXQsIHZhbGlkYXRpb25zLCBwbHVnaW5NYW5hZ2VyLCByZXBvcnRGaWxlKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG1hbmlmZXN0cyA9IGF3YWl0IHN5bnRoQXBwKGNvbW1hbmQsIG91dGRpciwgc3Rkb3V0LCByZWNvcmRDb25zdHJ1Y3RNZXRhZGF0YSk7XG4gICAgICBpZiAodmFsaWRhdGlvbnMpIHtcbiAgICAgICAgY29uc3QgcGx1Z2luTWFuYWdlciA9IG5ldyBQbHVnaW5NYW5hZ2VyKHBsdWdpbnNEaXIpO1xuICAgICAgICBhd2FpdCB2YWxpZGF0ZUFwcChtYW5pZmVzdHMsIHN0ZG91dCwgdmFsaWRhdGlvbnMsIHBsdWdpbk1hbmFnZXIsIHJlcG9ydEZpbGUpO1xuICAgICAgfVxuICAgIH1cblxuXG4gIH1cblxufVxuXG5hc3luYyBmdW5jdGlvbiBmZXRjaFZhbGlkYXRpb25zKCk6IFByb21pc2U8VmFsaWRhdGlvbkNvbmZpZ1tdIHwgdW5kZWZpbmVkPiB7XG4gIGlmICh0eXBlb2YoY29uZmlnLnZhbGlkYXRpb25zKSA9PT0gJ3N0cmluZycpIHtcbiAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgZG93bmxvYWQoY29uZmlnLnZhbGlkYXRpb25zKTtcbiAgICByZXR1cm4geWFtbC5wYXJzZShjb250ZW50KSBhcyBWYWxpZGF0aW9uQ29uZmlnW107XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGNvbmZpZy52YWxpZGF0aW9ucztcbiAgfVxufVxuXG5cbm1vZHVsZS5leHBvcnRzID0gbmV3IENvbW1hbmQoKTtcbiJdfQ==