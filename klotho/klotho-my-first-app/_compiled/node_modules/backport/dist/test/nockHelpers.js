"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.listenForCallsToNockScope = exports.mockGqlRequest = void 0;
const url_1 = require("url");
const graphql_tag_1 = __importDefault(require("graphql-tag"));
const graphql_tag_2 = require("graphql-tag");
const nock_1 = __importDefault(require("nock"));
(0, graphql_tag_2.disableFragmentWarnings)();
function mockGqlRequest({ name, statusCode, body, headers, apiBaseUrl, }) {
    const { origin, pathname } = new url_1.URL(
    // default to localhost as host to avoid CORS issues
    apiBaseUrl ?? 'http://localhost/graphql');
    const scope = (0, nock_1.default)(origin)
        .post(pathname, (body) => {
        return getQueryNameFromString(body.query) === name;
    })
        .reply(statusCode, body, headers);
    return listenForCallsToNockScope(scope);
}
exports.mockGqlRequest = mockGqlRequest;
function getQueryNameFromString(query) {
    const obj = (0, graphql_tag_1.default)(query);
    // @ts-expect-error
    return obj.definitions[0].name.value;
}
function listenForCallsToNockScope(scope) {
    const calls = [];
    scope.on('request', (req, interceptor, body) => {
        calls.push(JSON.parse(body));
    });
    return calls;
}
exports.listenForCallsToNockScope = listenForCallsToNockScope;
